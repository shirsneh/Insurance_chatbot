FROM python:3.9-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

COPY config/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .
COPY chatbot.py .
COPY rag_system.py .
COPY llm_handlers.py .
COPY utils.py .
COPY api.py .
COPY create_vectorstore.py .
COPY docker/docker_init.py .

RUN mkdir -p data models policy_docs

# Create a startup script that will initialize the vector store if needed
RUN echo '#!/bin/bash\n\
echo "Starting Insurance Chatbot API..."\n\
echo "Checking for policy documents..."\n\
if [ -d "policy_docs" ] && [ "$(ls -A policy_docs/*.pdf 2>/dev/null)" ]; then\n\
    echo "Found policy documents, creating vector store..."\n\
    python docker_init.py\n\
    if [ $? -eq 0 ]; then\n\
        echo "Vector store created successfully"\n\
    else\n\
        echo "Vector store creation failed, will be created at runtime"\n\
    fi\n\
else\n\
    echo "No policy documents found, vector store will be created when documents are added"\n\
fi\n\
echo "Starting FastAPI application..."\n\
exec python api.py' > /app/start.sh

RUN chmod +x /app/start.sh

# Expose API port
EXPOSE 8000

CMD ["/app/start.sh"]
